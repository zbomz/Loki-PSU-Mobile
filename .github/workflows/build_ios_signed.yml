name: Build iOS App (Signed)

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-ios-signed:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Analyze code
      run: flutter analyze

    - name: Run tests
      run: flutter test

    - name: Install Apple Certificate and Provisioning Profile
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE }}
      run: |
        # Create temporary keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        # Create and unlock keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        # Import certificate
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > $CERTIFICATE_PATH
        security import $CERTIFICATE_PATH -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        
        # Set keychain as default
        security list-keychain -d user -s $KEYCHAIN_PATH
        security default-keychain -s $KEYCHAIN_PATH
        security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        # Install provisioning profile
        PROVISIONING_PROFILE_PATH=$RUNNER_TEMP/profile.mobileprovision
        echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > $PROVISIONING_PROFILE_PATH
        
        # Copy to proper location
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PROVISIONING_PROFILE_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
        
        # Get UUID from provisioning profile
        PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin <<< $(/usr/bin/security cms -D -i $PROVISIONING_PROFILE_PATH))
        cp $PROVISIONING_PROFILE_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision

    - name: Build iOS (Release - Signed)
      run: |
        flutter build ipa --release \
          --export-options-plist=ios/ExportOptions.plist

    - name: Upload Signed IPA
      uses: actions/upload-artifact@v4
      with:
        name: loki-psu-ios-signed
        path: build/ios/ipa/*.ipa
        retention-days: 30

    - name: Cleanup
      if: always()
      run: |
        # Clean up keychain and certificates
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        rm -f $RUNNER_TEMP/certificate.p12 || true
        rm -f $RUNNER_TEMP/profile.mobileprovision || true
